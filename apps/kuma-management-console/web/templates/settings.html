{% extends "base.html" %}
{% block title %}Settings - Kuma Management Console{% endblock %}

{% block content %}
<div class="settings-container">
    <h1>Account Settings</h1>
    
    <div class="settings-grid">
        {# Change Password #}
        <div class="card">
            <h2>Change Password</h2>
            <form method="POST" class="settings-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="action" value="change_password">
                
                <div class="form-group">
                    <label for="current_password">Current Password</label>
                    <input type="password" 
                           id="current_password" 
                           name="current_password" 
                           class="form-input" 
                           autocomplete="current-password"
                           required>
                </div>
                
                <div class="form-group">
                    <label for="new_password">New Password</label>
                    <input type="password" 
                           id="new_password" 
                           name="new_password" 
                           class="form-input" 
                           autocomplete="new-password"
                           minlength="8"
                           required>
                    <small class="form-help">Min 8 chars with uppercase, lowercase, and number</small>
                </div>
                
                <div class="form-group">
                    <label for="confirm_password">Confirm New Password</label>
                    <input type="password" 
                           id="confirm_password" 
                           name="confirm_password" 
                           class="form-input" 
                           autocomplete="new-password"
                           required>
                </div>
                
                <button type="submit" class="btn btn-primary">Change Password</button>
            </form>
        </div>
        
        {# Two-Factor Authentication #}
        <div class="card">
            <h2>Two-Factor Authentication</h2>
            
            {% if show_recovery_codes %}
            {# Show Recovery Codes After Enabling 2FA #}
            <div class="recovery-codes-display">
                <div class="success-message">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                    <span>Two-factor authentication is now enabled!</span>
                </div>
                
                <div class="recovery-codes-warning">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                        <line x1="12" y1="9" x2="12" y2="13"></line>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                    <div>
                        <strong>Save these recovery codes!</strong>
                        <p>Store them in a safe place. You can use them to access your account if you lose your authenticator.</p>
                    </div>
                </div>
                
                <div class="recovery-codes-grid">
                    {% for code in recovery_codes %}
                    <code class="recovery-code">{{ code }}</code>
                    {% endfor %}
                </div>
                
                <button type="button" class="btn btn-secondary" onclick="copyRecoveryCodes()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                    Copy All Codes
                </button>
                
                <a href="{{ url_for('auth.settings') }}" class="btn btn-primary" style="margin-left: 0.5rem;">Done</a>
            </div>
            
            <script>
            function copyRecoveryCodes() {
                const codes = {{ recovery_codes | tojson }};
                const text = codes.join('\n');
                navigator.clipboard.writeText(text).then(() => {
                    showToast('Recovery codes copied to clipboard!', 'success');
                }).catch(() => {
                    showToast('Failed to copy codes', 'error');
                });
            }
            </script>
            
            {% elif show_2fa_setup %}
            {# 2FA Setup Flow #}
            <div class="2fa-setup">
                <p>Scan this QR code with your authenticator app:</p>
                <div class="qr-code">
                    <img src="{{ qr_code }}" alt="2FA QR Code">
                </div>
                <p class="secret-display">
                    <strong>Manual entry:</strong><br>
                    <code>{{ secret }}</code>
                </p>
                
                <form method="POST" class="settings-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="action" value="verify_2fa">
                    
                    <div class="form-group">
                        <label for="totp_token">Enter 6-digit code to verify</label>
                        <input type="text" 
                               id="totp_token" 
                               name="totp_token" 
                               class="form-input" 
                               placeholder="000000"
                               inputmode="numeric"
                               pattern="[0-9]{6}"
                               maxlength="6"
                               autocomplete="one-time-code"
                               required
                               autofocus>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Verify & Enable 2FA</button>
                </form>
            </div>
            
            {% elif user.totp_enabled %}
            {# 2FA Enabled - Show Disable Option #}
            <div class="2fa-status enabled">
                <p>✅ Two-factor authentication is <strong>enabled</strong></p>
            </div>
            
            {# Recovery Codes Status #}
            <div class="recovery-codes-status">
                <div class="recovery-info-box">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                    <div>
                        <strong>Recovery Codes</strong>
                        <p>{{ user.get_recovery_codes_count() }} codes remaining</p>
                    </div>
                </div>
                
                {% if user.get_recovery_codes_count() < 3 %}
                <p class="recovery-warning">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                    </svg>
                    Running low on recovery codes. Consider regenerating them.
                </p>
                {% endif %}
                
                <form method="POST" class="regenerate-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="action" value="regenerate_recovery">
                    
                    <div class="form-group">
                        <label for="totp_token_regen">Enter 2FA code to regenerate recovery codes</label>
                        <input type="text" 
                               id="totp_token_regen" 
                               name="totp_token" 
                               class="form-input" 
                               placeholder="000000"
                               inputmode="numeric"
                               pattern="[0-9]{6}"
                               maxlength="6"
                               autocomplete="one-time-code"
                               required>
                    </div>
                    
                    <button type="submit" class="btn btn-secondary">Regenerate Recovery Codes</button>
                </form>
            </div>
            
            <hr class="settings-divider">
            
            <form method="POST" class="settings-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="action" value="disable_2fa">
                
                <div class="form-group">
                    <label for="totp_token_disable">Enter 2FA code to disable</label>
                    <input type="text" 
                           id="totp_token_disable" 
                           name="totp_token" 
                           class="form-input" 
                           placeholder="000000"
                           inputmode="numeric"
                           pattern="[0-9]{6}"
                           maxlength="6"
                           autocomplete="one-time-code"
                           required>
                </div>
                
                <button type="submit" class="btn btn-danger">Disable 2FA</button>
            </form>
            
            {% else %}
            {# 2FA Not Enabled #}
            <div class="2fa-status disabled">
                <p>⚠️ Two-factor authentication is <strong>not enabled</strong></p>
                <p class="text-muted">Adding 2FA provides an extra layer of security for your account.</p>
            </div>
            
            <form method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="action" value="enable_2fa">
                <button type="submit" class="btn btn-primary">Enable 2FA</button>
            </form>
            {% endif %}
        </div>
        
        {# Account Info #}
        <div class="card">
            <h2>Account Information</h2>
            <dl class="info-list">
                <dt>Username</dt>
                <dd>{{ user.username }}</dd>
                
                <dt>Role</dt>
                <dd>{% if user.is_admin %}Administrator{% else %}User{% endif %}</dd>
                
                <dt>Account Created</dt>
                <dd>{{ user.created_at.strftime('%Y-%m-%d %H:%M') if user.created_at else 'Unknown' }}</dd>
                
                <dt>Last Login</dt>
                <dd>{{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else 'Never' }}</dd>
            </dl>
        </div>
    </div>
</div>
{% endblock %}
