#!/bin/sh

PACKAGE="synology-monitor"
PID_FILE="/var/packages/${PACKAGE}/target/ui.pid"
SCHED_PID_FILE="/var/packages/${PACKAGE}/target/scheduler.pid"
HELPER_SCRIPT="/var/packages/${PACKAGE}/target/smart-helper.sh"
SYSLOG_HELPER_SCRIPT="/var/packages/${PACKAGE}/target/system-log-helper.sh"
SCHEDULER_SCRIPT="/var/packages/${PACKAGE}/target/monitor-scheduler.sh"
CRON_MARKER="synology-monitor smart helper auto"
SYSLOG_CRON_MARKER="synology-monitor system log helper auto"
SCHEDULER_CRON_MARKER="synology-monitor scheduled checks auto"

cleanup_helper_schedule() {
    if command -v crontab >/dev/null 2>&1; then
        current="$(crontab -l 2>/dev/null || true)"
        cleaned="$(printf "%s\n" "${current}" | sed "/${CRON_MARKER}/d")"
        printf "%s\n" "${cleaned}" | crontab - >/dev/null 2>&1 || true
    fi

    if [ -w /etc/crontab ]; then
        tmp_file="/tmp/${PACKAGE}-crontab-clean.$$"
        sed "/${CRON_MARKER}/d" /etc/crontab >"${tmp_file}" 2>/dev/null || cp /etc/crontab "${tmp_file}"
        cp "${tmp_file}" /etc/crontab 2>/dev/null || true
        rm -f "${tmp_file}"
    fi
}

cleanup_scheduler_schedule() {
    if command -v crontab >/dev/null 2>&1; then
        current="$(crontab -l 2>/dev/null || true)"
        cleaned="$(printf "%s\n" "${current}" | sed "/${SCHEDULER_CRON_MARKER}/d")"
        printf "%s\n" "${cleaned}" | crontab - >/dev/null 2>&1 || true
    fi
    if [ -w /etc/crontab ]; then
        tmp_file="/tmp/${PACKAGE}-crontab-scheduler-clean.$$"
        sed "/${SCHEDULER_CRON_MARKER}/d" /etc/crontab >"${tmp_file}" 2>/dev/null || cp /etc/crontab "${tmp_file}"
        cp "${tmp_file}" /etc/crontab 2>/dev/null || true
        rm -f "${tmp_file}"
    fi
}

cleanup_syslog_helper_schedule() {
    if command -v crontab >/dev/null 2>&1; then
        current="$(crontab -l 2>/dev/null || true)"
        cleaned="$(printf "%s\n" "${current}" | sed "/${SYSLOG_CRON_MARKER}/d")"
        printf "%s\n" "${cleaned}" | crontab - >/dev/null 2>&1 || true
    fi
    if [ -w /etc/crontab ]; then
        tmp_file="/tmp/${PACKAGE}-crontab-syslog-clean.$$"
        sed "/${SYSLOG_CRON_MARKER}/d" /etc/crontab >"${tmp_file}" 2>/dev/null || cp /etc/crontab "${tmp_file}"
        cp "${tmp_file}" /etc/crontab 2>/dev/null || true
        rm -f "${tmp_file}"
    fi
}

if [ -f "${PID_FILE}" ]; then
    PID="$(cat "${PID_FILE}")"
    if kill -0 "${PID}" 2>/dev/null; then
        kill "${PID}" || true
    fi
    rm -f "${PID_FILE}"
fi

if [ -f "${SCHED_PID_FILE}" ]; then
    SPID="$(cat "${SCHED_PID_FILE}")"
    if kill -0 "${SPID}" 2>/dev/null; then
        kill "${SPID}" || true
    fi
    rm -f "${SCHED_PID_FILE}"
fi

rm -f "${HELPER_SCRIPT}" 2>/dev/null || true
rm -f "${SYSLOG_HELPER_SCRIPT}" 2>/dev/null || true
rm -f "${SCHEDULER_SCRIPT}" 2>/dev/null || true
cleanup_helper_schedule
cleanup_syslog_helper_schedule
cleanup_scheduler_schedule

exit 0
